name: 9ï¸âƒ£ Destroy Infra AWS ğŸ’£

on:
  workflow_dispatch:
    inputs:
      terraform_action:
        description: "AÃ§Ã£o do Terraform (destroy)"
        required: true
        default: "destroy"
        type: choice
        options:
          - destroy

env:
  S3_STATE_BUCKET: pucrs-crypto-github-action-tfstate-unique
  DYNAMO_LOCK_TABLE: pucrs-crypto-terraform-lock
  TF_MAIN_DIR: ./iac/flow
  AWS_REGION: us-east-1

jobs:
  terraform:
    name: "Terraform ${{ github.event.inputs.terraform_action }}"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.TF_MAIN_DIR }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: âš™ï¸ Configurar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: ğŸ§± Terraform Init
        id: init
        run: terraform init -reconfigure

      - name: ğŸ’£ Executar Terraform Destroy
        id: destroy
        run: terraform destroy -auto-approve

      - name: ğŸ—‘ï¸ Excluir Tabela DynamoDB do Backend
        run: |
          echo "ğŸ—‘ï¸ Excluindo tabela DynamoDB: ${{ env.DYNAMO_LOCK_TABLE }}"
          aws dynamodb delete-table \
            --table-name ${{ env.DYNAMO_LOCK_TABLE }} \
            --region ${{ env.AWS_REGION }} || true
          echo "âœ… DynamoDB ${{ env.DYNAMO_LOCK_TABLE }} excluÃ­da (ou jÃ¡ inexistente)."

      - name: ğŸ§¹ Limpar e Excluir Bucket S3 (versÃµes, markers e bucket)
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          BUCKET=${{ env.S3_STATE_BUCKET }}
          echo "ğŸ§¹ Deletando versÃµes e delete markers do bucket: $BUCKET"

          aws s3api list-object-versions --bucket "$BUCKET" --output json \
            | jq -r '.Versions[]?, .DeleteMarkers[]? | [.Key, .VersionId] | @tsv' \
            | while IFS=$'\t' read -r key versionId; do
                aws s3api delete-object --bucket "$BUCKET" --key "$key" --version-id "$versionId" || true
              done

          echo "ğŸª£ Excluindo bucket S3..."
          aws s3api delete-bucket --bucket "$BUCKET" --region ${{ env.AWS_REGION }} || true
          echo "âœ… Bucket S3 $BUCKET excluÃ­do com sucesso (ou jÃ¡ inexistente)."

      - name: ğŸ‰ Notificar Sucesso
        run: echo "ğŸ‰ Infraestrutura destruÃ­da e backend AWS limpo com sucesso!"
