name: 9Ô∏è‚É£ Destroy Infra AWS üí£ 

# 0Ô∏è‚É£ 1Ô∏è‚É£ 2Ô∏è‚É£ 3Ô∏è‚É£ 4Ô∏è‚É£ 5Ô∏è‚É£ 6Ô∏è‚É£ 7Ô∏è‚É£ 8Ô∏è‚É£ 9Ô∏è‚É£

on:
  workflow_dispatch:
    inputs:
      terraform_action:
        description: "A√ß√£o do Terraform (destroy)"
        required: true
        default: "destroy"
        type: choice
        options:
          - destroy

env:
  S3_STATE_BUCKET: pucrs-crypto-github-action-tfstate-unique
  DYNAMO_LOCK_TABLE: pucrs-crypto-terraform-lock
  TF_MAIN_DIR: ./iac/flow
  AWS_REGION: us-east-1

jobs:
  terraform:
    name: "Terraform ${{ github.event.inputs.terraform_action }}"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.TF_MAIN_DIR }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          # Use a mesma vers√£o que est√° no seu setup.yml
          terraform_version: 1.5.0

      - name: Terraform Init
        id: init
        # Necess√°rio para carregar o backend S3/DynamoDB e o estado
        run: terraform init -reconfigure

      # 1Ô∏è‚É£ Destr√≥i a infra principal
      - name: üí£ Executar Terraform Destroy
        working-directory: ${{ env.TF_MAIN_DIR }}
        id: destroy
        # O -auto-approve √© necess√°rio aqui, pois n√£o h√° intera√ß√£o na Action
        #run: terraform destroy -auto-approve
        run: |
          terraform init -reconfigure
          terraform destroy -auto-approve

      # 2Ô∏è‚É£ Limpa e remove DynamoDB do backend
      - name: üí£ Excluir DynamoDB via AWS CLI
        run: |
          echo "üóëÔ∏è Excluindo tabela DynamoDB ${{ env.DYNAMO_LOCK_TABLE }}"
          aws dynamodb delete-table --table-name ${{ env.DYNAMO_LOCK_TABLE }} --region ${{env.AWS_REGION}} || true

          echo "‚úÖ DynamoDB ${{ env.DYNAMO_LOCK_TABLE }} exclu√≠do com sucesso!"
         

      # 2Ô∏è‚É£ Limpa e remove o bucket S3 e DynamoDB do backend
      - name: üí£ Excluir bucket S3 e DynamoDB via AWS CLI
        run: |
          echo "üßπ Limpando bucket S3: ${{ env.S3_STATE_BUCKET }}"
          aws s3 rm s3://${{ env.S3_STATE_BUCKET }} --recursive || true

          echo "ü™£ Excluindo bucket S3..."
          aws s3api delete-bucket --bucket ${{ env.S3_STATE_BUCKET }} --region ${{env.AWS_REGION}} || true


          # üßπ Deletar todas as vers√µes e delete markers
          aws s3api delete-objects \
            --bucket ${{ env.S3_STATE_BUCKET }} \
            --delete "$(aws s3api list-object-versions \
              --bucket ${{ env.S3_STATE_BUCKET }} \
              --output=json \
              --query='{Objects: Versions[].{Key:Key,VersionId:VersionId}}')"
                  
          # üßπ Deletar delete markers
          aws s3api delete-objects \
            --bucket ${{ env.S3_STATE_BUCKET }} \
            --delete "$(aws s3api list-object-versions \
              --bucket ${{ env.S3_STATE_BUCKET }} \
              --output=json \
              --query='{Objects: DeleteMarkers[].{Key:Key,VersionId:VersionId}}')"
                  
          # ü™£ Agora sim, excluir o bucket
          aws s3api delete-bucket --bucket ${{ env.S3_STATE_BUCKET }} --region ${{env.AWS_REGION}} || true


          echo "‚úÖ S3 ${{ env.S3_STATE_BUCKET }} exclu√≠do com sucesso!"

      # 2Ô∏è‚É£ Notifica usu√°rio
      - name: üéâ Notificar Sucesso
        run: echo "üéâ Todos os recursos gerenciados pelo Terraform foram destru√≠dos com sucesso!"
