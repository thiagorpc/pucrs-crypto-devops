name: 2. Workflow Backend

on:
  # ðŸ”¹ Dispara automaticamente quando houver push na pasta crypto-api
  push:
    branches:
      - main
    paths:
      - "crypto-api/**"

  # ðŸ”¹ Dispara automaticamente quando o workflow Setup AWS for concluÃ­do
  workflow_run:
    workflows: ["1. Setup Infra AWS"]
    types:
      - completed

  # ðŸ”¹ Permite execuÃ§Ã£o manual via GitHub UI
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: pucrs-crypto-api-repo
  TF_WORKING_DIR: ./iac/flow

jobs:
  deploy_api:
    name: ðŸš€ Build, Push & Deploy Backend Task
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
    - name: ðŸ“¦ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ” Configurar Credenciais AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # -------------------------------------------------------------------
    # ðŸ§© Somente roda se o evento for "workflow_run"
    # -------------------------------------------------------------------
    - name: â¬‡ï¸ Baixar o Artefato da Ãšltima ExecuÃ§Ã£o do Setup.yml
      if: github.event_name == 'workflow_run'
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: 01_setup.yml
        name: terraform-apply-status
        path: .
        check_artifacts: true

    - name: ðŸ§© Verificar existÃªncia do arquivo de status
      if: github.event_name == 'workflow_run'
      id: check_file
      run: |
        if [ ! -f "./apply_status.txt" ]; then
          echo "file_exists=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Arquivo de status nÃ£o encontrado."
        else
          echo "file_exists=true" >> $GITHUB_OUTPUT
          echo "âœ… Arquivo de status encontrado."
        fi

    - name: ðŸ›‘ Parar se nÃ£o hÃ¡ status vÃ¡lido
      if: github.event_name == 'workflow_run' && steps.check_file.outputs.file_exists == 'false'
      run: |
        echo "âŒ Arquivo de status nÃ£o encontrado. Provavelmente o Terraform Apply nÃ£o foi executado."
        exit 1

    - name: ðŸ§° Garantir jq instalado
      if: github.event_name == 'workflow_run'
      run: sudo apt-get install -y jq

    - name: ðŸ“– Ler status JSON do Setup AWS
      if: github.event_name == 'workflow_run' && steps.check_file.outputs.file_exists == 'true'
      id: read_status
      run: |
        echo "ðŸ“„ ConteÃºdo do arquivo de status:"
        cat ./apply_status.txt
        APPLY_STATUS=$(jq -r '.apply' ./apply_status.txt)
        echo "apply_status=$APPLY_STATUS" >> $GITHUB_OUTPUT
        echo "ðŸ” apply_status = $APPLY_STATUS"

    - name: ðŸ›‘ Parar se o Apply nÃ£o foi sucesso
      if: github.event_name == 'workflow_run' && steps.read_status.outputs.apply_status != 'success'
      run: |
        echo "âœ… Setup anterior nÃ£o foi um Apply 'success' (Status: ${{ steps.read_status.outputs.apply_status }}). Ignorando o deploy."


    # ðŸ”‘ Login no Amazon ECR
    - name: ðŸ”‘ Login no Amazon ECR
      if: >
        github.event_name != 'workflow_run' ||
        (github.event_name == 'workflow_run' && steps.read_status.outputs.apply_status == 'success')

      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # ðŸ·ï¸ Definir variÃ¡veis da imagem
    - name: ðŸ·ï¸ Definir VariÃ¡veis de Imagem
      if: >
        github.event_name != 'workflow_run' ||
        (github.event_name == 'workflow_run' && steps.read_status.outputs.apply_status == 'success')

      id: vars
      run: |
        IMAGE_TAG=$(echo ${{ github.sha }} | cut -c1-7)
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
        ECR_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
        echo "ECR_URI=$ECR_URI" >> $GITHUB_OUTPUT
        echo "Tag definida: $IMAGE_TAG"
        echo "ECR URI: $ECR_URI"

    # ðŸ³ Build & Push
    - name: ðŸ³ Build, Tag e Push da Imagem
      if: >
        github.event_name != 'workflow_run' ||
        (github.event_name == 'workflow_run' && steps.read_status.outputs.apply_status == 'success')
      run: |
        docker build -t ${{ steps.vars.outputs.ECR_URI }}:${{ steps.vars.outputs.IMAGE_TAG }} ./crypto-api
        docker tag ${{ steps.vars.outputs.ECR_URI }}:${{ steps.vars.outputs.IMAGE_TAG }} ${{ steps.vars.outputs.ECR_URI }}:latest
        docker push ${{ steps.vars.outputs.ECR_URI }}:${{ steps.vars.outputs.IMAGE_TAG }}
        docker push ${{ steps.vars.outputs.ECR_URI }}:latest

    # âš™ï¸ Terraform Init & Apply
    - name: âš™ï¸ Configurar Terraform
      if: >
        github.event_name != 'workflow_run' ||
        (github.event_name == 'workflow_run' && steps.read_status.outputs.apply_status == 'success')

      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0

    - name: ðŸ§± Terraform Init
      if: >
        github.event_name != 'workflow_run' ||
        (github.event_name == 'workflow_run' && steps.read_status.outputs.apply_status == 'success')
      run: terraform init
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: ðŸš€ Terraform Apply (Deploy)
      if: >
        github.event_name != 'workflow_run' ||
        (github.event_name == 'workflow_run' && steps.read_status.outputs.apply_status == 'success')
      run: terraform apply -auto-approve -var="image_tag=${{ steps.vars.outputs.IMAGE_TAG }}"
      working-directory: ${{ env.TF_WORKING_DIR }}
