name: 009. Destroy Infra AWS - Gold Standard

on:
  workflow_dispatch:
    inputs:
      # ForÃ§a a confirmaÃ§Ã£o manual da destruiÃ§Ã£o na interface do Actions
      confirm_destroy:
        description: "ConfirmaÃ§Ã£o de DestruiÃ§Ã£o: Digite 'destroy' para continuar."
        required: true
        default: ""
        type: string

permissions:
  id-token: write
  contents: read

env:
  TF_VAR_env: ${{ secrets.TF_ENV }}
  AWS_REGION: "us-east-1"
  TF_MAIN_DIR: ./iac/flow

jobs:
  terraform-destroy:
    name: ğŸ’£ Destruir Infraestrutura e Limpar Backend
    runs-on: ubuntu-latest

    # Adiciona uma verificaÃ§Ã£o extra para garantir que o usuÃ¡rio digitou 'destroy'
    if: github.event.inputs.confirm_destroy == 'destroy'

    defaults:
      run:
        working-directory: ${{ env.TF_MAIN_DIR }}

    steps:
      # -----------------------
      # ğŸ”¹ 1. Checkout do RepositÃ³rio
      # -----------------------
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      # -----------------------
      # ğŸ”¹ 2. Setup Terraform
      # -----------------------
      - name: âš™ï¸ Configurar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          # Use a versÃ£o mais estÃ¡vel/recente. Manter 1.5.0, mas 1.9.x Ã© melhor se possÃ­vel.
          terraform_version: 1.5.0 
        
      # -----------------------
      # ğŸ”¹ 3. Configurar Credenciais AWS
      # -----------------------
      # NOTA: Manteremos o Access Key/Secret Key para consistÃªncia com seus exemplos, 
      # mas o OIDC (OpenID Connect) seria a melhor prÃ¡tica de seguranÃ§a.
      - name: ğŸ” Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
        
      # -----------------------
      # ğŸ”¹ 4. Inicializar Terraform
      # -----------------------
      - name: ğŸ§± Terraform Init
        run: terraform init -reconfigure -input=false
      
      # -----------------------
      # ğŸ”¹ 5. Criar Plano de DestruiÃ§Ã£o (SeguranÃ§a Operacional)
      # -----------------------
      - name: ğŸ“ Criar Plano de DestruiÃ§Ã£o
        run: terraform plan -destroy -out=tfplan.destroy
      
      # -----------------------
      # ğŸ”¹ 6. Aplicar DestruiÃ§Ã£o
      # -----------------------
      - name: ğŸ”¥ Aplicar DestruiÃ§Ã£o (Auto-Aprovar)
        run: terraform apply -auto-approve tfplan.destroy
      
      # ----------------------------------------
      # ğŸ”¹ 7. Limpar Artefatos do Backend (CRÃTICO)
      # ----------------------------------------
      # A partir daqui, mudamos o working-directory para o raiz do repo,
      # pois a CLI da AWS nÃ£o depende de arquivos .tf
      - name: ğŸ›  Instalar jq para limpeza de S3
        run: sudo apt-get update && sudo apt-get install -y jq
        working-directory: ${{ github.workspace }}
      
      - name: ğŸ—‘ï¸ Excluir Tabela DynamoDB do Backend
        run: |
          echo "ğŸ—‘ï¸ Excluindo tabela DynamoDB: ${{ env.DYNAMO_LOCK_TABLE }}"
          # O '|| true' garante que o workflow nÃ£o falhe se a tabela jÃ¡ nÃ£o existir
          aws dynamodb delete-table \
            --table-name ${{ env.DYNAMO_LOCK_TABLE }} \
            --region ${{ env.AWS_REGION }} || true
          echo "âœ… DynamoDB ${{ env.DYNAMO_LOCK_TABLE }} excluÃ­da (ou jÃ¡ inexistente)."
        working-directory: ${{ github.workspace }}
      
      - name: ğŸ§¹ Limpar e Excluir Bucket S3 (VersÃµes e Bucket)
        run: |
          BUCKET=${{ env.S3_STATE_BUCKET }}
          echo "ğŸ§¹ Deletando versÃµes e delete markers do bucket: $BUCKET"
      
          # Script para listar e deletar TODAS as versÃµes e delete markers do bucket
          aws s3api list-object-versions --bucket "$BUCKET" --output json --region ${{ env.AWS_REGION }} \
            | jq -r '.Versions[]?, .DeleteMarkers[]? | [.Key, .VersionId] | @tsv' \
            | while IFS=$'\t' read -r key versionId; do
                aws s3api delete-object --bucket "$BUCKET" --key "$key" --version-id "$versionId" --region ${{ env.AWS_REGION }} || true
              done
      
          echo "ğŸª£ Excluindo bucket S3..."
          # Exclui o bucket vazio
          aws s3api delete-bucket --bucket "$BUCKET" --region ${{ env.AWS_REGION }} || true
          echo "âœ… Bucket S3 $BUCKET excluÃ­do com sucesso (ou jÃ¡ inexistente)."
        working-directory: ${{ github.workspace }}
      
      - name: ğŸ‰ Sucesso
        run: echo "ğŸ‰ Infraestrutura destruÃ­da e backend AWS limpo com sucesso!"
        working-directory: ${{ github.workspace }}
