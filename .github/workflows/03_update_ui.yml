name: 3Ô∏è‚É£ Workflow Frontend

on:
  push:
    branches:
      - main
    paths:
      - 'crypto-ui/**' # ‚ùóÔ∏è Trigger: Apenas quando h√° push na pasta do Frontend

  #workflow_run:
  #  workflows: ["üöÄ 2. Setup Inicial da Infraestrutura (Terraform)"]
  #  types:
  #    - completed

env:
  AWS_REGION: us-east-1
  S3_BUCKET_UI: pucrs-crypto-ui 

jobs:
  deploy_ui:
    name: Build & Sync S3
    runs-on: ubuntu-latest

    env: 
      API_URL_ALB: ""

    defaults:
      run:
        working-directory: ./crypto-ui # Assume que o c√≥digo React est√° na pasta 'ui'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      
      - name: üéØ Obter DNS do NLB
        id: get_alb_dns
        run: |
          # 1. Busca o nome DNS do NLB pelo seu nome fixo
          ALB_DNS_NAME=$(aws elbv2 describe-load-balancers \
            --names "crypto-api-nlb" \
            --region ${{ env.AWS_REGION }} \
            --query "LoadBalancers[0].DNSName" \
            --output text)
          
          # 2. Verifica se o nome DNS foi encontrado
          if [ -z "$ALB_DNS_NAME" ]; then
            echo "Erro: N√£o foi poss√≠vel encontrar o DNS para o NLB 'crypto-api-nlb'."
            exit 1
          fi
          
          # 3. Define a vari√°vel de ambiente para ser usada nos pr√≥ximos passos
          # Usamos o comando set-output (deprecated, mas funciona) ou salvamos em um arquivo
          echo "API_URL_ALB=https://$ALB_DNS_NAME" >> $GITHUB_ENV
          echo "DNS do NLB obtido: https://$ALB_DNS_NAME"

      # 1. Instala√ß√£o de Depend√™ncias e Build do Frontend
      - name: Instalar Depend√™ncias
        run: npm install

      - name: Build do Projeto React/UI
        run: VITE_API_URL=${{ env.API_URL_ALB }} npm run build

      # 2. Sincroniza√ß√£o com S3
      - name: Sync Build com S3 Bucket
        run: |
          aws s3 sync dist s3://${{ env.S3_BUCKET_UI }} --delete --cache-control max-age=300
        # --acl public-read - Removi porque optei por definir object_ownership = "BucketOwnerEnforced"
        # --delete remove arquivos que n√£o existem mais no build local
        # --acl public-read garante que os usu√°rios possam acessar
        # --cache-control max-age=300
