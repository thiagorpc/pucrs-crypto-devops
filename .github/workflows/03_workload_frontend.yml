name: 3. Workflow Frontend

on:
  # üîπ Dispara automaticamente quando houver push na pasta crypto-ui
  push:
    branches:
      - main
    paths:
      - "crypto-ui/**"

  # üîπ Dispara automaticamente quando o workflow Setup AWS for conclu√≠do
  workflow_run:
    workflows: ["1. Setup Infra AWS"]
    types:
      - completed

  # üîπ Permite execu√ß√£o manual via GitHub UI
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  S3_BUCKET_UI: pucrs-crypto-frontend
  NLB_NAME: pucrs-crypto-api-nlb
  APIGW_NAME: pucrs-crypto-api-gateway

jobs:
  deploy_ui:
    name: üåê Build & Deploy Frontend
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4

      - name: üîê Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # -------------------------------------------------------------------
      # üß© Somente roda se o evento for "workflow_run"
      # -------------------------------------------------------------------
      - name: ‚¨áÔ∏è Baixar o Artefato da √öltima Execu√ß√£o do Setup.yml
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: 01_setup.yml
          name: terraform-apply-status
          path: .
          check_artifacts: true
        
      - name: üß© Verificar exist√™ncia do arquivo de status
        if: github.event_name == 'workflow_run'
        id: check_file
        run: |
          if [ ! -f "./apply_status.txt" ]; then
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Arquivo de status n√£o encontrado."
          else
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Arquivo de status encontrado."
          fi

      - name: üõë Parar se n√£o h√° status v√°lido
        if: github.event_name == 'workflow_run' && steps.check_file.outputs.file_exists == 'false'
        run: |
          echo "‚ùå Arquivo de status n√£o encontrado. Provavelmente o Terraform Apply n√£o foi executado."
          exit 1

      - name: üß∞ Garantir jq instalado
        if: github.event_name == 'workflow_run'
        run: sudo apt-get install -y jq

      - name: üìñ Ler status JSON do Setup AWS
        if: github.event_name == 'workflow_run' && steps.check_file.outputs.file_exists == 'true'
        id: read_status
        run: |
          echo "üìÑ Conte√∫do do arquivo de status:"
          cat ./apply_status.txt
          APPLY_STATUS=$(jq -r '.apply' ./apply_status.txt)
          echo "apply_status=$APPLY_STATUS" >> $GITHUB_OUTPUT
          echo "üîç apply_status = $APPLY_STATUS"

      - name: üõë Parar se o Apply n√£o foi sucesso
        if: github.event_name == 'workflow_run' && steps.read_status.outputs.apply_status != 'success'
        run: |
          echo "‚ùå O √∫ltimo Terraform Apply n√£o foi conclu√≠do com sucesso."
          exit 1
      # -------------------------------------------------------------------
      
        
      
        # üåç Obter DNS do NLB
      - name: üéØ Obter DNS do NLB
        id: get_nlb_dns
        run: |
          NLB_DNS_NAME=$(aws elbv2 describe-load-balancers \
            --names ${{ env.NLB_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query "LoadBalancers[0].DNSName" \
            --output text)
          if [ -z "$NLB_DNS_NAME" ]; then
            echo "Erro: N√£o foi poss√≠vel encontrar o DNS para o NLB ${{ env.NLB_NAME }}."
            exit 1
          fi
          echo "API_URL_NLB=https://$NLB_DNS_NAME" >> $GITHUB_ENV
          echo "‚úÖ DNS do NLB obtido: https://$NLB_DNS_NAME"

      - name: üéØ Obter DNS do API Gateway
        id: get_api_gateway_dns
        run: |
          # 1. Obter o ID do API Gateway (necess√°rio, pois o nome n√£o √© um par√¢metro direto)
          APIGW_ID=$(aws apigateway get-rest-apis \
            --region ${{ env.AWS_REGION }} \
            --query "items[?name=='${{ env.APIGW_NAME }}'].id" \
            --output text)
        
          if [ -z "$APIGW_ID" ]; then
            echo "Erro: N√£o foi poss√≠vel encontrar o ID para o API Gateway ${{ env.APIGW_NAME }}."
            exit 1
          fi
          
          # 2. Construir o DNS base (formato padr√£o do API Gateway)
          # A URL do API Gateway √©: https://<id>.execute-api.<regi√£o>.amazonaws.com/<stage>
          APIGW_STAGE="prod"
          
          APIGW_DNS_NAME="${APIGW_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com/${APIGW_STAGE}"
          
          # 3. Exportar a vari√°vel
          echo "API_URL=https://$APIGW_DNS_NAME" >> $GITHUB_ENV
          echo "‚úÖ DNS do API Gateway obtido: https://$APIGW_DNS_NAME"
          

      # ‚öôÔ∏è Instalar depend√™ncias e buildar
      - name: üì¶ Instalar Depend√™ncias
        working-directory: ./crypto-ui
        run: npm install

      - name: üß± Build do Projeto React/UI
        working-directory: ./crypto-ui   
        run: VITE_API_URL=${{ env.API_URL_NLB }} npm run build

      # ‚òÅÔ∏è Enviar build para o S3
      - name: ‚òÅÔ∏è Sync Build com S3 Bucket
        working-directory: ./crypto-ui
        run: |
          aws s3 sync dist s3://${{ env.S3_BUCKET_UI }} --delete --cache-control max-age=300

      - name: üåê Exibir URL do Site Est√°tico no S3
        run: |
          echo "üîç Verificando configura√ß√£o de site est√°tico para o bucket: ${{ env.S3_BUCKET_UI }}"

          # Obt√©m a configura√ß√£o de hospedagem de site do bucket
          HOSTING_CONFIG=$(aws s3api get-bucket-website --bucket ${{ env.S3_BUCKET_UI }} 2>/dev/null || true)

          if [ -n "$HOSTING_CONFIG" ]; then
            # URL p√∫blica do modo website
            WEBSITE_URL="http://${{ env.S3_BUCKET_UI }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
            echo "‚úÖ Site est√°tico habilitado!"
            echo "üåé Acesse em: $WEBSITE_URL"
            echo "URL=$WEBSITE_URL" >> $GITHUB_OUTPUT
          else
            # Caso o bucket N√ÉO tenha website hosting habilitado
            OBJECT_URL="https://${{ env.S3_BUCKET_UI }}.s3.${{ env.AWS_REGION }}.amazonaws.com/index.html"
            echo "‚ö†Ô∏è O bucket n√£o est√° configurado como site est√°tico."
            echo "Voc√™ ainda pode acessar o arquivo diretamente:"
            echo "üîó $OBJECT_URL"
            echo "URL=$OBJECT_URL" >> $GITHUB_OUTPUT
          fi

