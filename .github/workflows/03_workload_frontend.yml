name: 3ï¸âƒ£ Workflow Frontend

on:
  push:
    branches:
      - main
    paths:
      - "crypto-ui/**" # Trigger apenas quando hÃ¡ push na pasta do Frontend

  workflow_run:
    workflows: ["1ï¸âƒ£ Setup Infra AWS"] # Nome exato do workflow
    types:
      - completed

env:
  AWS_REGION: us-east-1
  S3_BUCKET_UI: pucrs-crypto-ui

jobs:
  deploy_ui:
    name: Build & Sync S3
    runs-on: ubuntu-latest

    env:
      API_URL_ALB: ""

    defaults:
      run:
        working-directory: ./crypto-ui # Assume que o cÃ³digo React estÃ¡ na pasta 'crypto-ui'

    # Executa apenas se workflow_run foi concluÃ­do com sucesso ou se for push
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸŽ¯ Obter DNS do NLB
        id: get_alb_dns
        run: |
          ALB_DNS_NAME=$(aws elbv2 describe-load-balancers \
            --names "crypto-api-nlb" \
            --region ${{ env.AWS_REGION }} \
            --query "LoadBalancers[0].DNSName" \
            --output text)
          if [ -z "$ALB_DNS_NAME" ]; then
            echo "Erro: NÃ£o foi possÃ­vel encontrar o DNS para o NLB 'crypto-api-nlb'."
            exit 1
          fi
          echo "API_URL_ALB=https://$ALB_DNS_NAME" >> $GITHUB_ENV
          echo "DNS do NLB obtido: https://$ALB_DNS_NAME"

      - name: Instalar DependÃªncias
        run: npm install

      - name: Build do Projeto React/UI
        run: VITE_API_URL=${{ env.API_URL_ALB }} npm run build

      - name: Sync Build com S3 Bucket
        run: |
          aws s3 sync dist s3://${{ env.S3_BUCKET_UI }} --delete --cache-control max-age=300
