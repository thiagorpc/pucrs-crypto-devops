name: 3. Workflow Frontend

on:
  # ðŸ”¹ Dispara automaticamente quando houver push na pasta crypto-ui
  push:
    branches:
      - main
    paths:
      - "crypto-ui/**"

  # ðŸ”¹ Dispara automaticamente quando o workflow Setup AWS for concluÃ­do
  workflow_run:
    workflows: ["1. Setup Infra AWS"]
    types:
      - completed

  # ðŸ”¹ Permite execuÃ§Ã£o manual via GitHub UI
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  S3_BUCKET_UI: pucrs-crypto-frontend
  NLB_NAME: pucrs-crypto-api-nlb
  APIGW_NAME: pucrs-crypto-api-gateway

# ===================================================================
# ðŸ§© JOB 1: PrÃ©-verificaÃ§Ã£o de Deploy
# ===================================================================
jobs:
  precheck:
    name: ðŸ§© Verificar CondiÃ§Ãµes de Deploy
    runs-on: ubuntu-latest
    outputs:
      deploy_allowed: ${{ steps.deploy_check.outputs.deploy_allowed }}
    steps:
      - name: ðŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ðŸ”¹ Apenas se o evento for workflow_run
      - name: â¬‡ï¸ Baixar Artefato do Setup AWS
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: 01_setup.yml
          name: terraform-apply-status
          path: .
          check_artifacts: true

      - name: ðŸ§© Validar status e definir variÃ¡vel
        id: deploy_check
        run: |
          if [[ "${GITHUB_EVENT_NAME}" != "workflow_run" ]]; then
            echo "deploy_allowed=true" >> $GITHUB_OUTPUT
            echo "ðŸŸ¢ Evento direto (push/manual). Deploy permitido."
            exit 0
          fi

          if [ ! -f "./apply_status.txt" ]; then
            echo "deploy_allowed=false" >> $GITHUB_OUTPUT
            echo "âŒ Arquivo de status nÃ£o encontrado. Ignorando deploy."
            exit 0
          fi

          APPLY_STATUS=$(jq -r '.apply' ./apply_status.txt)
          echo "ðŸ” apply_status = $APPLY_STATUS"

          if [[ "$APPLY_STATUS" == "success" ]]; then
            echo "deploy_allowed=true" >> $GITHUB_OUTPUT
            echo "âœ… Setup anterior bem-sucedido. Deploy permitido."
          else
            echo "deploy_allowed=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Setup anterior falhou. Deploy cancelado."
          fi

# ===================================================================
# ðŸš€ JOB 2: Build e Deploy do Frontend
# ===================================================================
  deploy_ui:
    name: ðŸŒ Build & Deploy Frontend
    runs-on: ubuntu-latest
    needs: precheck
    if: needs.precheck.outputs.deploy_allowed == 'true'

    steps:
      - name: ðŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ===============================================================
      # ðŸŒ Obter Endpoints da Infra (NLB e API Gateway)
      # ===============================================================

      - name: ðŸŽ¯ Obter DNS do NLB
        id: get_nlb_dns
        run: |
          NLB_DNS_NAME=$(aws elbv2 describe-load-balancers \
            --names ${{ env.NLB_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query "LoadBalancers[0].DNSName" \
            --output text)

          if [ -z "$NLB_DNS_NAME" ]; then
            echo "Erro: NÃ£o foi possÃ­vel encontrar o DNS para o NLB ${{ env.NLB_NAME }}."
            exit 1
          fi

          echo "API_URL_NLB=https://$NLB_DNS_NAME" >> $GITHUB_ENV
          echo "âœ… NLB DNS: https://$NLB_DNS_NAME"

      - name: ðŸŽ¯ Obter DNS do API Gateway
        id: get_api_gateway_dns
        run: |
          APIGW_ID=$(aws apigateway get-rest-apis \
            --region ${{ env.AWS_REGION }} \
            --query "items[?name=='${{ env.APIGW_NAME }}'].id" \
            --output text)

          if [ -z "$APIGW_ID" ]; then
            echo "Erro: NÃ£o foi possÃ­vel encontrar o ID para o API Gateway ${{ env.APIGW_NAME }}."
            exit 1
          fi

          APIGW_STAGE="prod"
          APIGW_DNS_NAME="${APIGW_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com/${APIGW_STAGE}"
          echo "APIGW_URL=https://$APIGW_DNS_NAME" >> $GITHUB_ENV
          echo "âœ… API Gateway DNS: https://$APIGW_DNS_NAME"

      # ===============================================================
      # âš™ï¸ Build do Frontend
      # ===============================================================

      - name: ðŸ“¦ Instalar DependÃªncias
        working-directory: ./crypto-ui
        run: npm ci

      - name: ðŸ§± Build do Projeto (React/Vite)
        working-directory: ./crypto-ui
        run: VITE_API_URL=${{ env.APIGW_URL }} npm run build

      # ===============================================================
      # â˜ï¸ Deploy no S3
      # ===============================================================

      - name: â˜ï¸ Upload Build para o S3
        working-directory: ./crypto-ui
        run: |
          aws s3 sync dist s3://${{ env.S3_BUCKET_UI }} --delete --cache-control max-age=300
          echo "âœ… Build sincronizado com o bucket: ${{ env.S3_BUCKET_UI }}"

      - name: ðŸŒ Exibir URL do Site EstÃ¡tico
        run: |
          HOSTING_CONFIG=$(aws s3api get-bucket-website --bucket ${{ env.S3_BUCKET_UI }} 2>/dev/null || true)

          if [ -n "$HOSTING_CONFIG" ]; then
            WEBSITE_URL="http://${{ env.S3_BUCKET_UI }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
            echo "âœ… Site estÃ¡tico habilitado!"
            echo "ðŸŒŽ URL: $WEBSITE_URL"
            echo "URL=$WEBSITE_URL" >> $GITHUB_OUTPUT
          else
            OBJECT_URL="https://${{ env.S3_BUCKET_UI }}.s3.${{ env.AWS_REGION }}.amazonaws.com/index.html"
            echo "âš ï¸ O bucket nÃ£o possui website hosting habilitado."
            echo "ðŸ”— Acesse: $OBJECT_URL"
            echo "URL=$OBJECT_URL" >> $GITHUB_OUTPUT
          fi
